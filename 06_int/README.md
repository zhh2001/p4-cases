# 带内网络遥测

## 示例简介

本示例实现了一个基于 P4 编程语言的带内网络遥测（In-band Network Telemetry，简称 INT）系统，支持在数据包传输路径中嵌入逐跳遥测信息，实现对网络状态的实时监控。该示例利用 IPv4 Options 头部扩展字段，在不引入额外控制消息的前提下，将交换路径中每跳节点的遥测信息（包括交换机 ID、输出端口号和当前排队长度）封装进数据包，并由接收端解析提取。

该示例的设计理念源自现代可编程数据面的遥测需求，适用于对网络性能、路径行为、瓶颈链路等实时分析的研究与教学场景。

## 网络拓扑结构

```text
                   +--+
                   |h4|
                   +--+
                    |
                    |
+--+      +--+     +--+     +--+
|h1+------+s1+-----+s3+-----+h3|
+--+      +--+     +--+     +--+
            |
            |
          +--+
          |s2|
          +--+
            |
            |
          +--+
          |h2|
          +--+
```

该拓扑构建了一个含四台主机（h1-h4）与三台交换机（s1-s3）的典型 INT 传输场景，其中 h1 向 h2 发送 UDP 流量，沿路径携带遥测信息并由 h2 接收解码。

## 核心功能与设计

### 1. 遥测信息嵌入机制

本示例通过扩展 IPv4 Options 字段实现遥测数据的逐跳注入。每个交换机在转发数据包时，将本地状态信息编码为自定义 INT 头部，附加至 IPv4 Options 中，具体字段如下：

- `swid`：交换机标识符；
- `qdepth`：当前 egress 端口队列长度（模拟值）；
- `portid`：出口端口编号。

### 2. 接收端解析功能

接收端（h2）运行专用脚本 `receive.py`，可对嵌入 IPv4 Options 字段中的 INT 信息进行解码，打印逐跳遥测字段，便于观察链路性能状态。

### 3. 可扩展性

本示例可根据需要扩展遥测字段、增加跳数上限，或与流分类器结合，实现条件式遥测、可编程采样等高级功能。

## 项目结构说明

```text
.
├── main.p4     # INT 功能的完整 P4 实现
├── main.py     # 自定义拓扑与交换机配置脚本
├── send.py     # h1 端发送测试数据包的脚本（包含预封装INT头）
└── receive.py  # h2 端接收并解析 INT 数据包的脚本
```

## 测试方法

### 1. 启动接收端监听进程

进入 h2 主机，并运行接收脚本以捕获遥测包：

```bash
python receive.py
```

### 2. 发送携带 INT 头部的数据包

进入 h1 主机，执行以下命令发送一条 UDP 报文至 h2，并预封装 INT 信息头部：

```bash
python send.py 10.0.2.2 "test" 1
```

### 3. 观察遥测数据输出

接收端将显示解析后的遥测信息，如：

```text
sniffing on h2-eth0
got a packet
###[ Ethernet ]### 
  dst = 00:00:0a:00:02:02
  src = 00:01:0a:00:02:02
###[ IP ]### 
  ihl     = 8
  options = 
    ###[ INT ]### 
      count = 2
      ###[ SwitchTrace ]### 
        swid   = 2
        qdepth = 0
        portid = 1
      ###[ SwitchTrace ]### 
        swid   = 1
        qdepth = 0
        portid = 2
```

### 4 中间交换机的作用说明

- s1 与 s2 负责在数据包转发过程中，追加其本地的遥测条目。

## 技术要点与实现细节

- **P4 INT 头定义**：通过 `header_type` 描述单条 `SwitchTrace` 字段，支持动态个数追加；
- **Options IHL 更新**：IPv4 IHL 字段根据 INT 头部长度自动更新；
- **INT 路径控制**：可通过匹配规则决定是否插入遥测信息，支持灵活策略配置；
- **性能建议**：若应用于真实环境，可考虑结合 Digest、Mirror 或压缩机制减小开销。
